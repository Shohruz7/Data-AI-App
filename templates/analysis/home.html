<!DOCTYPE html>
<html>
<head>
    <title>Data Upload and Analysis</title>
    <style>
        .btn {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .form-control {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .alert { padding: 12px; margin: 10px 0; border-radius: 4px; }
        .loading { opacity: 0.6; pointer-events: none; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        /* Layout */
        .layout { display: flex; align-items: stretch; height: calc(100vh - 52px); }
        .sidebar { width: 260px; min-width: 260px; background: #f8fafc; border-right: 1px solid #e5e7eb; height: 100%; position: sticky; top: 52px; overflow-y: auto; }
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .sidebar-title { font-weight: 600; }
        .chat-list { list-style: none; margin: 0; padding: 0; }
        .chat-list-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eef2f7; position: relative; }
        .chat-list-item:hover { background: #eef2f7; }
        .chat-list-item.active { background: #e2e8f0; font-weight: 600; }
        .kebab { position: absolute; right: 8px; top: 8px; display: none; }
        .chat-list-item:hover .kebab { display: inline-block; }
        .kebab-btn { background: transparent; border: none; cursor: pointer; font-size: 16px; padding: 2px 6px; }
        .kebab-menu { position: absolute; right: 8px; top: 28px; background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none; z-index: 10; }
        .kebab-menu button { display: block; width: 140px; text-align: left; background: none; border: none; padding: 8px 10px; cursor: pointer; }
        .kebab-menu button:hover { background: #f3f4f6; }
        .saved-badge { font-size: 11px; color: #059669; margin-left: 6px; }
        /* Chat area */
        .chat { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px; background: #ffffff; }
        .message { margin-bottom: 16px; }
        .message h4 { margin: 0 0 6px 0; }
        .composer { border-top: 1px solid #e5e7eb; padding: 12px; background: #fafafa; }
        .composer form { display: flex; gap: 8px; align-items: center; }
        .composer .form-control { flex: 1; margin: 0; }
        .upload-form { margin-bottom: 8px; }
        .chart-img { max-width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 4px; }
        /* Prevent text clipping on narrow screens */
        .message, .messages pre, .messages p { word-wrap: break-word; overflow-wrap: anywhere; word-break: break-word; }
        .messages pre { white-space: pre-wrap; }
        .chat-list-item .title { display: inline-block; white-space: normal; overflow-wrap: anywhere; word-break: break-word; padding-right: 28px; }

        .mobile-only { display: none; }
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 900; }
        .backdrop.show { display: block; }

        /* Responsive adjustments */
        @media (max-width: 900px) {
            .layout { flex-direction: column; height: auto; }
            /* Sidebar becomes off-canvas */
            .sidebar { position: fixed; left: 0; top: 52px; height: calc(100vh - 52px); max-height: none; width: 80%; max-width: 320px; transform: translateX(-100%); transition: transform 200ms ease; z-index: 1000; border-right: 1px solid #e5e7eb; }
            .sidebar.open { transform: translateX(0%); }
            .chat { min-height: 60vh; }
            .messages { max-height: 55vh; }
            .composer form { flex-direction: column; align-items: stretch; }
            .composer .form-control { width: 100%; }
            .btn { padding: 8px 12px; }
            .mobile-only { display: inline-block; }
        }

        @media (max-width: 600px) {
            .sidebar-header { flex-direction: column; align-items: stretch; gap: 8px; }
            .sidebar-title { margin-bottom: 4px; }
            .chart-img { max-height: 40vh; object-fit: contain; }
        }
    </style>
</head>
<body>
    {% include 'partials/nav.html' %}

    <div id="sidebar-backdrop" class="backdrop"></div>
    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">Chats</span>
                <div>
                    <a id="saved-toggle" href="#" class="btn btn-secondary" title="View saved chats">Saved</a>
                    <button id="new-chat-btn" class="btn btn-secondary" title="Start a new chat">New Chat</button>
                </div>
            </div>
            <ul id="chat-list" class="chat-list">
                {% for c in chats %}
                <li class="chat-list-item {% if c.id == active_chat_id %}active{% endif %}" data-chat-id="{{ c.id }}">
                    <span class="title">{{ c.title }}</span>{% if c.saved %}<span class="saved-badge">Saved</span>{% endif %}
                    <div class="kebab">
                        <button class="kebab-btn" aria-label="More">⋮</button>
                        <div class="kebab-menu">
                            <button class="save-chat">Save</button>
                            <button class="delete-chat">Delete</button>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </aside>

        <!-- Chat area -->
        <section class="chat">
            <!-- Mobile toggle for sidebar -->
            <div class="mobile-only" style="padding: 8px 12px;">
                <button id="toggle-sidebar-btn" class="btn btn-secondary">Chats</button>
            </div>
            <!-- Messages (scrollable) -->
            <div id="messages" class="messages">
                {% for entry in chat_history %}
                    <div class="message" data-chat-entry="true">
                        {% if entry.type == 'analysis' %}
                            <h4>Initial Analysis</h4>
                            <pre>{{ entry.content }}</pre>
                            {% if entry.chart %}
                                <img class="chart-img" src="data:image/png;base64,{{ entry.chart }}" alt="Data Chart" />
                            {% endif %}
                        {% elif entry.type == 'question' %}
                            <h4>You asked:</h4>
                            <p><strong>{{ entry.content }}</strong></p>
                            <h4>Response:</h4>
                            <pre>{{ entry.response }}</pre>
                        {% endif %}
                        <hr>
                    </div>
                {% endfor %}
            </div>

            <!-- Composer (bottom) -->
            <div class="composer">
                <form id="upload-form" class="upload-form" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="upload">
                    <input id="csv-file" name="file" type="file" accept=".csv,text/csv" style="display:none">
                    <button type="button" id="browse-csv-btn" class="btn btn-secondary">Browse CSV</button>
                </form>
                <div id="upload-status"></div>

                <form id="question-form">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="question">
                    <input type="text" id="question" name="question" class="form-control" placeholder="Ask about your data..." required>
                    <button type="button" class="btn btn-success" id="action-btn" title="Send">↑</button>
                </form>
                <div id="question-status"></div>
            </div>
        </section>
    </div>

    <script>
        // CSRF token for AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function setActiveChatInList(activeId) {
            const items = document.querySelectorAll('#chat-list .chat-list-item');
            items.forEach(li => {
                if (String(li.dataset.chatId) === String(activeId)) li.classList.add('active');
                else li.classList.remove('active');
            });
        }

        function renderChatList(chats, activeId) {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            chats.forEach(c => {
                const li = document.createElement('li');
                li.className = 'chat-list-item' + (String(c.id) === String(activeId) ? ' active' : '');
                li.dataset.chatId = c.id;
                li.innerHTML = `<span class="title">${c.title}</span>${c.saved ? '<span class="saved-badge">Saved</span>' : ''}
                    <div class="kebab">
                        <button class="kebab-btn" aria-label="More">⋮</button>
                        <div class="kebab-menu">
                            <button class="save-chat">Save</button>
                            <button class="delete-chat">Delete</button>
                        </div>
                    </div>`;
                list.appendChild(li);
            });
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            messages.forEach(entry => {
                const div = document.createElement('div');
                div.className = 'message';
                div.setAttribute('data-chat-entry', 'true');
                if (entry.type === 'analysis') {
                    div.innerHTML = `
                        <h4>Initial Analysis</h4>
                        <pre>${entry.content}</pre>
                        ${entry.chart ? `<img class=\"chart-img\" src=\"data:image/png;base64,${entry.chart}\" alt=\"Data Chart\" />` : ''}
                        <hr>
                    `;
                } else if (entry.type === 'question') {
                    div.innerHTML = `
                        <h4>You asked:</h4>
                        <p><strong>${entry.content}</strong></p>
                        <h4>Response:</h4>
                        <pre>${entry.response}</pre>
                        <hr>
                    `;
                }
                container.appendChild(div);
            });
            scrollMessagesToBottom();
        }

        function scrollMessagesToBottom() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }

        // Sidebar mobile toggle
        const sidebar = document.querySelector('.sidebar');
        const backdrop = document.getElementById('sidebar-backdrop');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', function() {
                sidebar.classList.add('open');
                backdrop.classList.add('show');
            });
        }
        backdrop.addEventListener('click', function() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('show');
        });
        window.addEventListener('resize', function() {
            // On larger screens ensure sidebar is visible and backdrop hidden
            if (window.innerWidth > 900) {
                sidebar.classList.remove('open');
                backdrop.classList.remove('show');
            }
        });

        // New Chat
        document.getElementById('new-chat-btn').addEventListener('click', function() {
            const formData = new FormData();
            formData.append('form_type', 'new_chat');
            fetch('{% url "analysis-home" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    renderChatList(data.chats, data.active_chat_id);
                    renderMessages([]);
                } else if (data.error) {
                    alert(data.error);
                }
            });
        });

        // Switch Chat (event delegation)
        document.getElementById('chat-list').addEventListener('click', function(e) {
            const li = e.target.closest('.chat-list-item');
            if (!li) return;
            const chatId = li.dataset.chatId;
            const formData = new FormData();
            formData.append('form_type', 'switch_chat');
            formData.append('chat_id', chatId);
            fetch('{% url "analysis-home" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    setActiveChatInList(data.active_chat_id);
                    renderMessages(data.messages || []);
                    // Close sidebar on mobile after switching chat
                    if (window.innerWidth <= 900) {
                        sidebar.classList.remove('open');
                        backdrop.classList.remove('show');
                    }
                }
            });
        });

        // File Upload Handler
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const actionBtn = document.getElementById('action-btn');
            const uploadStatus = document.getElementById('upload-status');
            
            // Show loading state
            actionBtn.textContent = 'Uploading...';
            actionBtn.disabled = true;
            uploadStatus.innerHTML = '<p class="loading">Uploading file...</p>';
            
            fetch('{% url "analysis-home" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadStatus.innerHTML = '<p class="success">File uploaded successfully!</p>';
                    
                    // Append analysis message at bottom
                    const messages = document.getElementById('messages');
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `
                        <h4>Initial Analysis</h4>
                        <pre>${data.gpt_response}</pre>
                        ${data.chart ? `<img class=\"chart-img\" src=\"data:image/png;base64,${data.chart}\" alt=\"Data Chart\" />` : ''}
                        <hr>
                    `;
                    messages.appendChild(div);
                    scrollMessagesToBottom();

                    // Update chat list (AI title)
                    if (data.chats) {
                        renderChatList(data.chats, data.active_chat_id);
                    }
                } else {
                    uploadStatus.innerHTML = '<p class="error">Upload failed: ' + data.error + '</p>';
                }
            })
            .catch(error => {
                uploadStatus.innerHTML = '<p class="error">Upload failed: ' + error.message + '</p>';
            })
            .finally(() => {
                actionBtn.textContent = 'Upload';
                actionBtn.disabled = false;
            });
        });

        // Question Handler
        document.getElementById('question-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const actionBtn = document.getElementById('action-btn');
            const questionStatus = document.getElementById('question-status');
            const question = document.getElementById('question').value;
            
            // Show loading state
            actionBtn.textContent = 'Asking...';
            actionBtn.disabled = true;
            questionStatus.innerHTML = '<p class="loading">Processing your question...</p>';
            
            fetch('{% url "analysis-home" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    questionStatus.innerHTML = '<p class="success">Question answered!</p>';
                    
                    // Append question/answer message at bottom
                    const messages = document.getElementById('messages');
                    const div = document.createElement('div');
                    div.className = 'message';
                    div.innerHTML = `
                        <h4>You asked:</h4>
                        <p><strong>${question}</strong></p>
                        <h4>Response:</h4>
                        <pre>${data.question_answer}</pre>
                        <hr>
                    `;
                    messages.appendChild(div);
                    scrollMessagesToBottom();

                    // Reset form
                    document.getElementById('question').value = '';
                } else {
                    questionStatus.innerHTML = '<p class="error">Failed to get answer: ' + data.error + '</p>';
                }
            })
            .catch(error => {
                questionStatus.innerHTML = '<p class="error">Failed to get answer: ' + error.message + '</p>';
            })
            .finally(() => {
                actionBtn.textContent = 'Ask';
                actionBtn.disabled = false;
            });
        });

        // Unified action button: upload if file selected else send question
        const actionBtn = document.getElementById('action-btn');
        const fileInput = document.getElementById('csv-file');
        actionBtn.addEventListener('click', function() {
            const uploadStatus = document.getElementById('upload-status');
            const questionStatus = document.getElementById('question-status');
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            if (file) {
                // Perform upload
                const formData = new FormData();
                formData.append('form_type', 'upload');
                formData.append('file', file);
                actionBtn.disabled = true;
                uploadStatus.innerHTML = '<p class="loading">Uploading file...</p>';
                fetch('{% url "analysis-home" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        uploadStatus.innerHTML = '<p class="success">File uploaded successfully!</p>';
                        const messages = document.getElementById('messages');
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `
                            <h4>Initial Analysis</h4>
                            <pre>${data.gpt_response}</pre>
                            ${data.chart ? `<img class=\"chart-img\" src=\"data:image/png;base64,${data.chart}\" alt=\"Data Chart\" />` : ''}
                            <hr>
                        `;
                        messages.appendChild(div);
                        scrollMessagesToBottom();
                        if (data.chats) {
                            renderChatList(data.chats, data.active_chat_id);
                        }
                        // clear file selection
                        fileInput.value = '';
                    } else {
                        uploadStatus.innerHTML = '<p class="error">Upload failed: ' + (data.error || 'Unknown error') + '</p>';
                    }
                })
                .catch(err => {
                    uploadStatus.innerHTML = '<p class="error">Upload failed: ' + err.message + '</p>';
                })
                .finally(() => {
                    actionBtn.disabled = false;
                });
            } else {
                // Perform question
                const questionInput = document.getElementById('question');
                const question = questionInput.value.trim();
                if (!question) return;
                const formData = new FormData();
                formData.append('form_type', 'question');
                formData.append('question', question);
                actionBtn.disabled = true;
                questionStatus.innerHTML = '<p class="loading">Processing your question...</p>';
                fetch('{% url "analysis-home" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        questionStatus.innerHTML = '<p class="success">Question answered!</p>';
                        const messages = document.getElementById('messages');
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `
                            <h4>You asked:</h4>
                            <p><strong>${question}</strong></p>
                            <h4>Response:</h4>
                            <pre>${data.question_answer}</pre>
                            <hr>
                        `;
                        messages.appendChild(div);
                        scrollMessagesToBottom();
                        questionInput.value = '';
                    } else {
                        questionStatus.innerHTML = '<p class="error">Failed to get answer: ' + (data.error || 'Unknown error') + '</p>';
                    }
                })
                .catch(err => {
                    questionStatus.innerHTML = '<p class="error">Failed to get answer: ' + err.message + '</p>';
                })
                .finally(() => {
                    actionBtn.disabled = false;
                });
            }
        });

        // Kebab interactions (open/close + save/delete)
        document.getElementById('chat-list').addEventListener('click', function(e) {
            const kebabBtn = e.target.closest('.kebab-btn');
            const saveBtn = e.target.closest('.save-chat');
            const deleteBtn = e.target.closest('.delete-chat');
            const item = e.target.closest('.chat-list-item');
            if (!item) return;
            const chatId = item.dataset.chatId;

            // Toggle kebab menu
            if (kebabBtn) {
                const menu = item.querySelector('.kebab-menu');
                const isOpen = menu.style.display === 'block';
                document.querySelectorAll('.kebab-menu').forEach(m => m.style.display = 'none');
                menu.style.display = isOpen ? 'none' : 'block';
                e.stopPropagation();
                return;
            }

            // Save chat
            if (saveBtn) {
                const formData = new FormData();
                formData.append('form_type', 'save_chat');
                formData.append('chat_id', chatId);
                fetch('{% url "analysis-home" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.chats) {
                        renderChatList(data.chats, '{{ active_chat_id }}');
                    }
                });
                return;
            }

            // Delete chat
            if (deleteBtn) {
                if (!confirm('Delete this chat? This cannot be undone.')) return;
                const formData = new FormData();
                formData.append('form_type', 'delete_chat');
                formData.append('chat_id', chatId);
                fetch('{% url "analysis-home" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        renderChatList(data.chats, data.active_chat_id);
                        renderMessages(data.messages || []);
                    }
                });
                return;
            }
        });

        // Hide kebab menus on outside click
        document.addEventListener('click', function() {
            document.querySelectorAll('.kebab-menu').forEach(m => m.style.display = 'none');
        });

        // Saved toggle (client-side filter)
        document.getElementById('saved-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            const list = document.getElementById('chat-list');
            const items = list.querySelectorAll('.chat-list-item');
            const showingOnlySaved = list.dataset.onlySaved === '1';
            if (showingOnlySaved) {
                // Show all
                items.forEach(li => li.style.display = '');
                list.dataset.onlySaved = '0';
                this.textContent = 'Saved';
            } else {
                // Show only saved
                items.forEach(li => {
                    const hasSaved = !!li.querySelector('.saved-badge');
                    li.style.display = hasSaved ? '' : 'none';
                });
                list.dataset.onlySaved = '1';
                this.textContent = 'All';
            }
        });

        // On load, scroll to bottom
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        });

        // Trigger file picker
        const browseBtn = document.getElementById('browse-csv-btn');
        if (browseBtn && fileInput) {
            browseBtn.addEventListener('click', function() {
                fileInput.click();
            });
            fileInput.addEventListener('change', function() {
                const name = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
                const uploadStatus = document.getElementById('upload-status');
                if (name) uploadStatus.innerHTML = '<p class="success">Selected: ' + name + '</p>';
            });
        }
    </script>
</body>
</html>
